<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›¸ä¼¼ä¸‰è§’å½¢çš„æ‡‰ç”¨ å‡ºé¡Œå°å¹«æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMMZMGDqlrmqiKRfenibuzV1PveAAi1xubgAMlQHBVICfgNxw" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzOK91vil/MfLF/r5TCmiRabC/CCLLyQPA-" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURPlLfgvEodFrYVwqTxdMVJnWO6gQrGSxgVIx0s24NNhLvYGHd5iR6" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .config-btn.active {
            background-color: #f97316; /* orange-500 */
            color: white;
            font-weight: bold;
            border-color: #f97316;
        }
        #achievement-toast {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        #achievement-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .choice-btn {
            transition: all 0.2s;
        }
        .choice-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .choice-btn.correct {
            background-color: #22c55e; /* green-500 */
            color: white;
            border-color: #16a34a;
        }
        .choice-btn.incorrect {
            background-color: #ef4444; /* red-500 */
            color: white;
            border-color: #dc2626;
        }
        #scratchpad-canvas {
            touch-action: none;
            cursor: crosshair;
        }
        #report-section table, .worksheet-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #report-section th, #report-section td, .worksheet-table th, .worksheet-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        #report-section th, .worksheet-table th {
            background-color: #f8fafc;
        }
        #report-section .question-truncate, .worksheet-table .question-truncate {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div class="container mx-auto p-4 max-w-3xl">
        <header class="bg-white rounded-xl shadow-md p-6 mb-6 text-center">
            <h1 class="text-3xl font-bold text-sky-700">å‡ºé¡Œå°å¹«æ‰‹</h1>
            <h2 class="text-xl text-stone-600 mt-1">å–®å…ƒï¼š1-4 ç›¸ä¼¼ä¸‰è§’å½¢çš„æ‡‰ç”¨</h2>
            <p class="text-xs text-gray-500 mt-2">è¨­è¨ˆè€…ï¼šlkoj / ç‰ˆæœ¬ï¼šv1.0 / æ—¥æœŸï¼š20250921</p>
            <div class="flex justify-center my-2">
                <!--è¨ˆæ•¸å™¨çš„åœ–åƒå·²è¢«è¨­å®šçš„éˆæ¥ç«™é»ã€‚ä¸è¦åŸ·è¡Œä»£ç¢¼çš„ä»»ä½•ä¿®æ”¹ã€‚-->
                <nobr><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td><a href="https://www.stylemap.co.jp/counter/taiwan/"><img src="https://www.f-counter.net/ani1/66/1757816192/" alt="ç¶²ç«™è¨ˆæ•¸å™¨" border="0" style="margin:0px; padding:0px; border:0px; vertical-align:bottom"></a></td>
                <td><a href="https://www.stylemap.co.jp/counter/taiwan/"><img src="https://www.f-counter.net/ani2/66/1757816192/" alt="ç¶²ç«™è¨ˆæ•¸å™¨" border="0" style="margin:0px; padding:0px; border:0px; vertical-align:bottom"></a></td></tr></tbody></table></nobr>
            </div>
            <p class="text-stone-600 mt-2">ï¼ˆæ ¹æ“šå‚™èª²ç”¨æ›¸ä¾‹é¡Œï¼Œç‚ºæ‚¨é‡èº«æ‰“é€ çš„éš¨æ©Ÿå‡ºé¡Œç·´ç¿’ç³»çµ±ã€‚ï¼‰</p>
        </header>

        <main>
            <!-- Control Panel -->
            <div id="control-panel" class="bg-white rounded-xl shadow-md p-6 mb-6">
                <div class="mb-4">
                    <label for="student-name" class="block font-bold text-lg mb-2 text-stone-700">0. è«‹è¼¸å…¥å­¸ç”Ÿåå­—ï¼š</label>
                    <input type="text" id="student-name" class="w-full rounded border-gray-300 p-2 text-lg" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                </div>
                <div class="mb-4">
                    <label class="block font-bold text-lg mb-2 text-stone-700">1. è«‹é¸æ“‡è¦ç·´ç¿’çš„å–®å…ƒï¼š</label>
                    <div id="topic-selector" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="mb-4">
                    <label class="block font-bold text-lg mb-2 text-stone-700">2. è«‹è¨­å®šé¡Œç›®æ•¸å€¼ç¯„åœï¼š</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="range-min" class="w-24 rounded border-gray-300 text-center" value="2">
                        <span class="font-bold">åˆ°</span>
                        <input type="number" id="range-max" class="w-24 rounded border-gray-300 text-center" value="10">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block font-bold text-lg mb-2 text-stone-700">3. è«‹é¸æ“‡ç·´ç¿’é¡Œæ•¸ï¼š</label>
                    <div id="question-count-selector" class="flex flex-wrap gap-2">
                        <button data-count="5" class="config-btn q-count-btn px-4 py-2 rounded-lg transition-colors border-2 border-gray-200">5 é¡Œ</button>
                        <button data-count="10" class="config-btn q-count-btn px-4 py-2 rounded-lg transition-colors border-2 border-gray-200 active">10 é¡Œ</button>
                        <button data-count="20" class="config-btn q-count-btn px-4 py-2 rounded-lg transition-colors border-2 border-gray-200">20 é¡Œ</button>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t">
                    <label class="block font-bold text-lg mb-2 text-stone-700">4. è«‹é¸æ“‡æ“ä½œï¼š</label>
                    <div class="space-y-4">
                        <button id="start-practice-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors text-xl">é–‹å§‹äº’å‹•ç·´ç¿’</button>
                        <button id="export-worksheet-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-sky-700 transition-colors text-xl">åŒ¯å‡ºç´™æœ¬ç·´ç¿’ (WORD)</button>
                    </div>
                </div>
            </div>

            <div id="practice-session" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <div id="progress-tracker" class="text-lg font-semibold text-stone-600 h-6"></div>
                    <div class="flex items-center gap-4">
                        <div id="timer" class="text-lg font-bold text-sky-700">â±ï¸ 00:00</div>
                        <button id="home-btn" class="bg-stone-200 text-stone-700 font-bold py-2 px-4 rounded-lg hover:bg-stone-300 transition-colors">å›é¦–é </button>
                    </div>
                </div>
                <div id="question-card" class="bg-white rounded-xl shadow-md p-6 mb-6 min-h-[400px] flex flex-col items-center justify-center">
                    <div id="question-diagram" class="mb-4 w-full h-56 flex items-center justify-center"></div>
                    <p id="question-text" class="text-xl lg:text-2xl font-bold text-center text-stone-800"></p>
                </div>
                <div id="user-input-card" class="bg-white rounded-xl shadow-md p-6 mb-6">
                    <div id="answer-options-container" class="flex flex-wrap items-center justify-center gap-4">
                        <!-- Dynamic content: MCQ buttons -->
                    </div>
                    <p id="feedback-text" class="text-center font-bold text-lg mt-4 h-6"></p>
                    <div class="flex justify-center mt-4">
                        <button id="next-question-btn" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition-colors hidden">ä¸‹ä¸€é¡Œ</button>
                    </div>
                    <div id="answer-summary" class="rounded-xl shadow-inner p-6 mt-4 hidden">
                        <p id="guidance-text" class="text-lg font-bold mb-2"></p>
                        <div id="answer-steps" class="text-base sm:text-lg whitespace-pre-wrap p-3 bg-white/50 rounded"></div>
                        <hr class="my-4">
                        <p id="answer-final" class="text-2xl font-bold"></p>
                    </div>
                </div>
                <!-- Scratchpad Card -->
                <div id="scratchpad-card" class="bg-white rounded-xl shadow-md p-4 mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-stone-600">è¨ˆç®—ç´™</h3>
                        <button id="clear-scratchpad" class="bg-stone-200 text-sm px-3 py-1 rounded-lg hover:bg-stone-300">æ¸…é™¤</button>
                    </div>
                    <canvas id="scratchpad-canvas" class="w-full h-48 bg-stone-50 rounded-lg border"></canvas>
                </div>
            </div>

            <div id="report-section" class="bg-white rounded-xl shadow-md p-6 mt-8 hidden">
                <!-- Content is generated dynamically -->
            </div>
        </main>
    </div>
    
    <!-- Modals and hidden elements -->
    <div id="resume-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <p class="text-xl mb-4">åµæ¸¬åˆ°ä¸Šæ¬¡çš„ç·´ç¿’é€²åº¦ï¼Œè¦ç¹¼çºŒå—ï¼Ÿ</p>
            <button id="resume-yes" class="bg-green-500 text-white px-6 py-2 rounded-lg mr-4">ç¹¼çºŒç·´ç¿’</button>
            <button id="resume-no" class="bg-red-500 text-white px-6 py-2 rounded-lg">é‡æ–°é–‹å§‹</button>
        </div>
    </div>
    
    <div id="achievements-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">æˆ‘çš„æˆå°±å¾½ç« </h2>
                <button id="close-achievements" class="text-2xl font-bold">&times;</button>
            </div>
            <div id="achievements-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <div id="achievement-toast" class="fixed bottom-5 right-5 bg-yellow-400 text-yellow-900 p-4 rounded-lg shadow-lg flex items-center gap-4 z-50">
        <span class="text-3xl">ğŸ†</span>
        <div>
            <p class="font-bold">æˆå°±è§£é–ï¼</p>
            <p id="toast-text"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            function renderMath(element) {
                if (window.renderMathInElement) {
                    renderMathInElement(element || document.body, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                }
            }

            const topics = [
                { id: 'simple_measurement', name: 'ç°¡æ˜“æ¸¬é‡' },
                { id: 'area_perimeter_ratios', name: 'é¢ç©èˆ‡å‘¨é•·é—œä¿‚' },
                { id: 'special_triangles', name: 'ç‰¹æ®Šç›´è§’ä¸‰è§’å½¢' },
                { id: 'trig_ratios', name: 'ä¸‰è§’æ¯”' }
            ];

            let appState = {
                studentName: '', currentTopic: null, minRange: 2, maxRange: 10,
                startTime: null, practiceLog: [], totalQuestions: 10,
                currentQuestionIndex: 0, isSessionActive: false,
                achievements: {}, correctStreak: 0,
                sessionAchievements: []
            };
            
            const studentNameInput = document.getElementById('student-name');
            const topicSelector = document.getElementById('topic-selector');
            const rangeMinInput = document.getElementById('range-min');
            const rangeMaxInput = document.getElementById('range-max');
            const startPracticeBtn = document.getElementById('start-practice-btn');
            const exportWorksheetBtn = document.getElementById('export-worksheet-btn');
            const questionText = document.getElementById('question-text');
            const questionDiagram = document.getElementById('question-diagram');
            const controlPanel = document.getElementById('control-panel');
            const practiceSession = document.getElementById('practice-session');
            const progressTracker = document.getElementById('progress-tracker');
            const answerOptionsContainer = document.getElementById('answer-options-container');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const feedbackText = document.getElementById('feedback-text');
            const reportSection = document.getElementById('report-section');
            const questionCountSelector = document.getElementById('question-count-selector');
            const answerSummary = document.getElementById('answer-summary');
            const guidanceText = document.getElementById('guidance-text');
            const answerSteps = document.getElementById('answer-steps');
            const answerFinal = document.getElementById('answer-final');
            const homeBtn = document.getElementById('home-btn');
            const timerEl = document.getElementById('timer');
            let timerInterval = null;
            let questionStartTime = null;
            let currentQuestion = null;
            let resizeScratchpad = () => {};

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function getRandomInt(min, max) {
                min = Math.ceil(min);
                max = Math.floor(max);
                if (min > max) [min, max] = [max, min];
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            function getRandomChoice(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            }

            function generateOptions(correctAnswer, generatorFn, isNumeric=true) {
                let options = new Set();
                 if (isNumeric) {
                    const correctNum = Number(correctAnswer.toFixed(2));
                    options.add(correctNum);
                     while (options.size < 4) {
                        const wrongAnswer = generatorFn();
                        options.add(Number(wrongAnswer.toFixed(2)));
                    }
                } else {
                    options.add(correctAnswer);
                     while (options.size < 4) {
                        const wrongAnswer = generatorFn();
                        if(wrongAnswer !== correctAnswer) options.add(wrongAnswer);
                    }
                }
                return shuffleArray(Array.from(options));
            }
            
            const questionGenerators = {
                simple_measurement: () => {
                    const type = getRandomChoice(['shadow', 'river']);
                    if (type === 'shadow') {
                        const h1 = (getRandomInt(15, 20) / 10); // 1.5 to 2.0 m
                        const ratio = getRandomInt(8, 20) / 10; // shadow ratio 0.8 to 2.0
                        const s1 = h1 * ratio;
                        const s2 = getRandomInt(appState.minRange, appState.maxRange);
                        const h2 = (h1 / s1) * s2;

                        const question = `ä¸€å€‹èº«é«˜ç‚º ${h1} å…¬å°ºçš„äººï¼Œå½±é•·ç‚º ${s1.toFixed(2)} å…¬å°ºã€‚åœ¨åŒä¸€æ™‚é–“ï¼Œæ—é‚Šä¸€æ£µæ¨¹çš„å½±é•·æ˜¯ ${s2} å…¬å°ºï¼Œè«‹å•æ¨¹é«˜æ˜¯å¤šå°‘å…¬å°ºï¼Ÿ`;
                        const answer = h2;
                        const steps = `ç”± AA ç›¸ä¼¼å¯çŸ¥ï¼Œç‰©é«˜èˆ‡å½±é•·æˆæ­£æ¯”ï¼š<br>
                                     $\\frac{äººçš„èº«é«˜}{äººçš„å½±é•·} = \\frac{æ¨¹çš„é«˜åº¦}{æ¨¹çš„å½±é•·}$<br>
                                     $\\frac{${h1}}{${s1.toFixed(2)}} = \\frac{x}{${s2}}$<br>
                                     $x = \\frac{${h1} \\times ${s2}}{${s1.toFixed(2)}} = ${answer.toFixed(2)}$ å…¬å°º`;
                        const options = generateOptions(answer, () => answer + getRandomInt(-3, 3) * 0.5 + 0.1);
                         const diagram = `<svg viewBox="0 0 150 70" class="w-full h-auto max-w-sm mx-auto"><line x1="10" y1="60" x2="140" y2="60" stroke="black"/><path d="M 30 60 V ${60 - h1*10}" stroke="blue" stroke-width="2"/><text x="20" y="${55 - h1*10}" font-size="5">${h1}m</text><path d="M 110 60 V ${60 - h2*2}" stroke="green" stroke-width="4"/><text x="115" y="${55-h2*2}" font-size="5">x</text><line x1="30" y1="${60 - h1*10}" x2="${30 - s1*10}" y2="60" stroke="orange" stroke-dasharray="2"/><line x1="110" y1="${60-h2*2}" x2="${110-s2*5}" y2="60" stroke="orange" stroke-dasharray="2"/><text x="${30 - s1*5}" y="68" font-size="5">${s1.toFixed(2)}m</text><text x="${110-s2*2.5}" y="68" font-size="5">${s2}m</text></svg>`;
                        return { question, answer, steps, options, diagram };
                    } else { // river
                        const d2 = getRandomInt(appState.minRange, appState.maxRange - 2);
                        const m_width = d2 + getRandomInt(1, 3);
                        const d1 = getRandomInt(appState.maxRange, appState.maxRange + 10);
                        const r_width = (d1 / d2) * m_width;

                        const question = `ç‚ºæ¸¬é‡æ²³å¯¬ $\\overline{AB}$ï¼Œåœ¨å²¸ä¸Šå–é» C, D, Eï¼Œä½¿å¾— $\\overline{AC} \\perp \\overline{CD}$ ä¸” $\\overline{DE} \\perp \\overline{CD}$ã€‚è‹¥æ¸¬å¾— $\\overline{AC}=${d1}$ å…¬å°ºï¼Œ$\\overline{CD}=${d2}$ å…¬å°ºï¼Œ$\\overline{DE}=${m_width}$ å…¬å°ºï¼Œæ±‚æ²³å¯¬ $\\overline{AB}$ï¼Ÿ`;
                        const answer = r_width;
                        const steps = `å› ç‚º $\\angle ACB = \\angle DCE$ (å°é ‚è§’) ä¸” $\\angle A = \\angle D = 90^\\circ$ï¼Œ<br>
                                     æ‰€ä»¥ $\\triangle ABC \\sim \\triangle DEC$ (AAç›¸ä¼¼)ã€‚<br>
                                     $\\frac{\\overline{AB}}{\\overline{DE}} = \\frac{\\overline{AC}}{\\overline{DC}}$<br>
                                     $\\frac{x}{${m_width}} = \\frac{${d1}}{${d2}}$<br>
                                     $x = \\frac{${d1} \\times ${m_width}}{${d2}} = ${answer.toFixed(2)}$ å…¬å°º`;
                        const options = generateOptions(answer, () => answer * (getRandomInt(5, 15)/10) );
                        const diagram = `<svg viewBox="0 0 120 100" class="w-full h-auto max-w-sm mx-auto"><path d="M 0 50 H 120" stroke="#38bdf8" stroke-width="20" fill="#7dd3fc"/><path d="M 20 0 V 100" stroke="black"/><path d="M 80 0 V 100" stroke="black"/><text x="18" y="8" font-size="5">A</text><text x="18" y="95" font-size="5">B</text><text x="82" y="8" font-size="5">C</text><text x="82" y="30" font-size="5">D</text><text x="102" y="30" font-size="5">E</text><line x1="20" y1="90" x2="80" y2="10" stroke-dasharray="2" stroke="black"/><text x="45" y="8" font-size="5">${d1}</text><text x="84" y="20" font-size="5">${d2}</text><text x="104" y="40" font-size="5">${m_width}</text></svg>`;
                        return { question, answer, steps, options, diagram };
                    }
                },
                area_perimeter_ratios: () => {
                    const type = getRandomChoice(['side_to_area', 'area_to_side', 'midpoint']);
                    if (type === 'side_to_area') {
                        const r1 = getRandomInt(appState.minRange, appState.maxRange - 2);
                        const r2 = r1 + getRandomInt(1,3);
                        const area1 = getRandomInt(10,30);
                        const area2 = area1 * (r2*r2) / (r1*r1);

                        const question = `è‹¥å…©ç›¸ä¼¼ä¸‰è§’å½¢çš„å°æ‡‰é‚Šé•·æ¯”ç‚º $${r1}:${r2}$ï¼Œä¸”å°ä¸‰è§’å½¢çš„é¢ç©ç‚º ${area1}ï¼Œå‰‡å¤§ä¸‰è§’å½¢çš„é¢ç©ç‚ºä½•ï¼Ÿ`;
                        const answer = area2;
                        const steps = `ç›¸ä¼¼ä¸‰è§’å½¢çš„é¢ç©æ¯” = å°æ‡‰é‚Šé•·çš„å¹³æ–¹æ¯”ã€‚<br>
                                     é¢ç©æ¯” = $${r1}^2 : ${r2}^2 = ${r1*r1} : ${r2*r2}$<br>
                                     è¨­å¤§ä¸‰è§’å½¢é¢ç©ç‚º xï¼Œå‰‡ $${area1} : x = ${r1*r1} : ${r2*r2}$<br>
                                     $x = \\frac{${area1} \\times ${r2*r2}}{${r1*r1}} = ${answer.toFixed(2)}$`;
                        const options = generateOptions(answer, () => answer + getRandomInt(-5, 5) + 0.1);
                        const diagram = `<svg viewBox="0 0 160 70" class="w-full h-auto max-w-sm mx-auto"><polygon points="10,60 50,60 30,30" fill="#fef9c3" stroke="#ca8a04"/><text x="25" y="25" font-size="5">A=${area1}</text><text x="75" y="45">~</text><polygon points="90,60 170,60 130,-10" fill="#fef9c3" stroke="#ca8a04"/><text x="125" y="0" font-size="5">A=?</text></svg>`;
                        return { question, answer, steps, options, diagram };

                    } else if (type === 'area_to_side') {
                        const r1 = getRandomInt(appState.minRange, appState.maxRange - 2);
                        const r2 = r1 + getRandomInt(1,3);
                        const area1 = r1*r1 * getRandomInt(2,5);
                        const area2 = r2*r2 * (area1 / (r1*r1));
                        const peri1 = (r1 + r1+1 + r1+2) * (r1);
                        const peri2 = peri1 * (r2/r1);
                        
                        const question = `è‹¥å…©ç›¸ä¼¼ä¸‰è§’å½¢çš„é¢ç©æ¯”ç‚º $${area1}:${area2}$ï¼Œä¸”å°ä¸‰è§’å½¢çš„å‘¨é•·ç‚º ${peri1}ï¼Œå‰‡å¤§ä¸‰è§’å½¢çš„å‘¨é•·ç‚ºä½•ï¼Ÿ`;
                        const answer = peri2;
                        const steps = `é¢ç©æ¯” = $${area1}:${area2} = ${r1*r1}:${r2*r2}$<br>
                                     é‚Šé•·æ¯” = $\\sqrt{${r1*r1}}:\\sqrt{${r2*r2}} = ${r1}:${r2}$<br>
                                     å‘¨é•·æ¯”ç­‰æ–¼é‚Šé•·æ¯”ï¼Œæ‰€ä»¥å‘¨é•·æ¯”ä¹Ÿæ˜¯ $${r1}:${r2}$ã€‚<br>
                                     è¨­å¤§ä¸‰è§’å½¢å‘¨é•·ç‚º xï¼Œå‰‡ $${peri1} : x = ${r1} : ${r2}$<br>
                                     $x = \\frac{${peri1} \\times ${r2}}{${r1}} = ${answer.toFixed(2)}$`;
                        const options = generateOptions(answer, () => answer + getRandomInt(-5, 5));
                        const diagram = `<svg viewBox="0 0 160 70" class="w-full h-auto max-w-sm mx-auto"><polygon points="10,60 50,60 30,30" fill="#fef9c3" stroke="#ca8a04"/><text x="15" y="25" font-size="5">A=${area1}, P=${peri1}</text><text x="75" y="45">~</text><polygon points="90,60 170,60 130,-10" fill="#fef9c3" stroke="#ca8a04"/><text x="95" y="0" font-size="5">A=${area2}, P=?</text></svg>`;
                        return { question, answer, steps, options, diagram };
                    } else { // midpoint
                        const big_area = getRandomInt(20, 100) * 4;
                        const small_area = big_area / 4;
                        const question = `$\\triangle ABC$ ä¸­ï¼ŒD, E, F åˆ†åˆ¥ç‚ºä¸‰é‚Šä¸­é»ï¼Œè‹¥ $\\triangle ABC$ çš„é¢ç©ç‚º ${big_area}ï¼Œå‰‡ä¸­é»é€£æˆçš„ $\\triangle DEF$ é¢ç©ç‚ºä½•ï¼Ÿ`;
                        const answer = small_area;
                        const steps = `ä¸‰è§’å½¢ä¸‰é‚Šä¸­é»é€£ç·šæ®µæ‰€å½¢æˆçš„æ–°ä¸‰è§’å½¢ï¼Œé¢ç©ç‚ºåŸä¸‰è§’å½¢é¢ç©çš„ $\\frac{1}{4}$ã€‚<br>
                                     $\\triangle DEF$ é¢ç© = $\\triangle ABC$ é¢ç© $\\times \\frac{1}{4}$<br>
                                     $= ${big_area} \\times \\frac{1}{4} = ${answer}$`;
                        const options = generateOptions(answer, () => getRandomChoice([big_area/2, big_area/3, big_area]));
                        const diagram = `<svg viewBox="0 0 120 100" class="w-full h-auto max-w-sm mx-auto"><polygon points="10,90 110,90 60,10" fill="#f1f5f9" stroke="black"/><text x="50" y="50" font-size="6">A=${big_area}</text><polygon points="85,50 60,90 35,50" fill="#fde68a" stroke="#f59e0b"/><text x="55" y="70" font-size="6">A=?</text></svg>`;
                        return { question, answer, steps, options, diagram };
                    }
                },
                special_triangles: () => {
                    const type = getRandomChoice(['45', '3060']);
                    if (type === '45') {
                        const leg = getRandomInt(appState.minRange, appState.maxRange);
                        const hyp = leg * Math.sqrt(2);
                        const given = getRandomChoice(['leg', 'hyp']);
                        if (given === 'leg') {
                            const question = `ä¸€å€‹ $45^\\circ-45^\\circ-90^\\circ$ çš„ç­‰è…°ç›´è§’ä¸‰è§’å½¢ï¼Œè‹¥ä¸€è‚¡é•·ç‚º ${leg}ï¼Œå…¶æ–œé‚Šé•·ç‚ºä½•ï¼Ÿ`;
                            const answer = hyp;
                            const steps = `é‚Šé•·æ¯”ç‚º $1:1:\\sqrt{2}$ã€‚<br>
                                         æ–œé‚Š = è‚¡é•· $\\times \\sqrt{2} = ${leg}\\sqrt{2} \\approx ${answer.toFixed(2)}$`;
                            const options = generateOptions(answer, () => leg * getRandomChoice([1, 2, Math.sqrt(3)]));
                             return { question, answer, steps, options };
                        } else {
                            const question = `ä¸€å€‹ $45^\\circ-45^\\circ-90^\\circ$ çš„ç­‰è…°ç›´è§’ä¸‰è§’å½¢ï¼Œè‹¥æ–œé‚Šé•·ç‚º ${hyp.toFixed(2)}ï¼Œå…¶ä¸€è‚¡é•·ç‚ºä½•ï¼Ÿ`;
                            const answer = leg;
                            const steps = `é‚Šé•·æ¯”ç‚º $1:1:\\sqrt{2}$ã€‚<br>
                                         è‚¡é•· = æ–œé‚Š $\\div \\sqrt{2} = \\frac{${hyp.toFixed(2)}}{\\sqrt{2}} = ${leg}$`;
                            const options = generateOptions(answer, () => hyp / getRandomChoice([1, 2, Math.sqrt(3)]));
                            return { question, answer, steps, options };
                        }
                    } else { // 30-60-90
                        const short_leg = getRandomInt(appState.minRange, appState.maxRange);
                        const long_leg = short_leg * Math.sqrt(3);
                        const hyp = short_leg * 2;
                        const given = getRandomChoice(['short', 'long', 'hyp']);

                        if (given === 'short') {
                             const question = `ä¸€å€‹ $30^\\circ-60^\\circ-90^\\circ$ çš„ç›´è§’ä¸‰è§’å½¢ï¼Œè‹¥ $30^\\circ$ è§’çš„å°é‚Šï¼ˆæœ€çŸ­é‚Šï¼‰é•·ç‚º ${short_leg}ï¼Œå…¶æ–œé‚Šé•·ç‚ºä½•ï¼Ÿ`;
                             const answer = hyp;
                             const steps = `é‚Šé•·æ¯”ç‚º $1:\\sqrt{3}:2$ã€‚æœ€çŸ­é‚Šå°æ‡‰æ¯”ä¾‹ 1ã€‚<br>
                                         æ–œé‚Šï¼ˆå°æ‡‰æ¯”ä¾‹ 2ï¼‰= æœ€çŸ­é‚Š $\\times 2 = ${short_leg} \\times 2 = ${answer}$`;
                             const options = generateOptions(answer, () => short_leg * getRandomChoice([1, Math.sqrt(2), Math.sqrt(3)]));
                             return { question, answer, steps, options };
                        } else if (given === 'long') {
                             const question = `ä¸€å€‹ $30^\\circ-60^\\circ-90^\\circ$ ã®ç›´è§’ä¸‰è§’å½¢ï¼Œè‹¥ $60^\\circ$ è§’ã®å°é‚Šé•·ç‚º ${long_leg.toFixed(2)}ï¼Œå…¶æœ€çŸ­é‚Šé•·ç‚ºä½•ï¼Ÿ`;
                             const answer = short_leg;
                             const steps = `é‚Šé•·æ¯”ç‚º $1:\\sqrt{3}:2$ã€‚$60^\\circ$ å°é‚Šå°æ‡‰æ¯”ä¾‹ $\\sqrt{3}$ã€‚<br>
                                          æœ€çŸ­é‚Šï¼ˆå°æ‡‰æ¯”ä¾‹ 1ï¼‰= $60^\\circ$å°é‚Š $\\div \\sqrt{3} = \\frac{${long_leg.toFixed(2)}}{\\sqrt{3}} = ${answer}$`;
                             const options = generateOptions(answer, () => long_leg / getRandomChoice([1, 2, Math.sqrt(2)]));
                             return { question, answer, steps, options };
                        } else { // hyp
                             const question = `ä¸€å€‹ $30^\\circ-60^\\circ-90^\\circ$ ã®ç›´è§’ä¸‰è§’å½¢ï¼Œè‹¥æ–œé‚Šé•·ç‚º ${hyp}ï¼Œå…¶ $60^\\circ$ è§’ã®å°é‚Šé•·ç‚ºä½•ï¼Ÿ`;
                             const answer = long_leg;
                             const steps = `é‚Šé•·æ¯”ç‚º $1:\\sqrt{3}:2$ã€‚æ–œé‚Šå°æ‡‰æ¯”ä¾‹ 2ã€‚<br>
                                         æœ€çŸ­é‚Š = æ–œé‚Š $\\div 2 = ${hyp} \\div 2 = ${short_leg}$<br>
                                         $60^\\circ$å°é‚Š = æœ€çŸ­é‚Š $\\times \\sqrt{3} = ${short_leg}\\sqrt{3} \\approx ${answer.toFixed(2)}$`;
                             const options = generateOptions(answer, () => hyp * getRandomChoice([0.5, 1, Math.sqrt(2)/2]));
                             return { question, answer, steps, options };
                        }
                    }
                },
                trig_ratios: () => {
                    const sides = getRandomChoice([[3,4,5], [5,12,13], [8,15,17], [7,24,25]]);
                    const a = sides[0], b = sides[1], c = sides[2];
                    const angle = getRandomChoice(['A', 'B']);
                    const ratio = getRandomChoice(['sin', 'cos', 'tan']);

                    const [opp, adj] = (angle === 'A') ? [a, b] : [b, a];
                    
                    let question, answer_val;
                    let answer_text = '';
                    switch(ratio) {
                        case 'sin':
                            answer_val = opp/c;
                            answer_text = `\\frac{${opp}}{${c}}`;
                            break;
                        case 'cos':
                            answer_val = adj/c;
                            answer_text = `\\frac{${adj}}{${c}}`;
                            break;
                        case 'tan':
                            answer_val = opp/adj;
                            answer_text = `\\frac{${opp}}{${adj}}`;
                            break;
                    }
                    question = `åœ¨ç›´è§’ $\\triangle ABC$ ä¸­ï¼Œ$\\angle C=90^\\circ$ï¼Œä¸‰é‚Šé•·åˆ†åˆ¥ç‚º ${a}, ${b}, ${c}$ã€‚è‹¥ $\\overline{BC}=${a}, \\overline{AC}=${b}$ï¼Œæ±‚ $\\${ratio}(${angle})$ï¼Ÿ`;

                    const steps = `ç›¸å°æ–¼è§’ ${angle}ï¼š<br>
                                 å°é‚Š = ${opp}ï¼Œé„°é‚Š = ${adj}ï¼Œæ–œé‚Š = ${c}<br>
                                 $\\${ratio}(${angle}) = \\frac{\\text{${(ratio==='tan' ? 'å°é‚Š' : (ratio==='sin'?'å°é‚Š':'é„°é‚Š'))}}}{\\text{${(ratio==='tan' ? 'é„°é‚Š' : 'æ–œé‚Š')}}} = ${answer_text}$`;
                    
                    const options = generateOptions(answer_val, () => {
                        const wrong_opp = getRandomChoice([a,b,c]);
                        const wrong_adj = getRandomChoice([a,b,c].filter(s => s !== wrong_opp));
                        return wrong_opp / wrong_adj;
                    });
                    const diagram = `<svg viewBox="0 0 100 70" class="w-full h-auto max-w-xs mx-auto"><polygon points="10,60 90,60 90,10" fill="#e0f2fe" stroke="#0ea5e9"/><text x="5" y="60" font-size="5">A</text><text x="92" y="60" font-size="5">C</text><text x="92" y="10" font-size="5">B</text><text x="45" y="68" font-size="5">${b}</text><text x="95" y="35" font-size="5">${a}</text><text x="40" y="30" font-size="5">${c}</text></svg>`;
                    return { question, answer: answer_val, steps, options, diagram };
                }
            };

            function getGuidanceText(topicId) {
                const guidanceMap = {
                    simple_measurement: "æ˜¯ä¸æ˜¯å¿˜è¨˜è¦ã€å°æ‡‰é‚Šæˆæ¯”ä¾‹ã€äº†å‘¢ï¼Ÿä¾‹å¦‚ï¼šé«˜å°é«˜ã€å½±é•·å°å½±é•·ã€‚",
                    area_perimeter_ratios: "è¨˜å¾—å–”ï¼é‚Šé•·ã€å‘¨é•·æ˜¯ä¸€æ¨£çš„æ¯”ä¾‹ï¼Œä½†ã€é¢ç©ã€çš„æ¯”ä¾‹è¦å¹³æ–¹ï¼",
                    special_triangles: "å£è¨£å†å¿µä¸€æ¬¡ï¼45åº¦æ˜¯ 1:1:âˆš2ï¼Œ30-60-90åº¦æ˜¯ 1:âˆš3:2ã€‚",
                    trig_ratios: "sin, cos, tan åªæ˜¯é‚Šé•·çš„ä»£è™Ÿï¼Œæƒ³æƒ³çœ‹è‰å¯«çš„ s, c, t æ€éº¼ç•«ï¼Œå°±ä¸æœƒææ··å°é‚Šã€é„°é‚Šå’Œæ–œé‚Šäº†ï¼"
                };
                return guidanceMap[topicId] || "æ²’é—œä¿‚ï¼Œæˆ‘å€‘å†ä¾†ä¸€æ¬¡ï¼";
            }
            
            function renderTopics() {
                topicSelector.innerHTML = '';
                topics.forEach(topic => {
                    const button = document.createElement('button');
                    button.id = `topic-${topic.id}`;
                    button.className = 'config-btn topic-select-btn px-4 py-2 rounded-lg transition-colors border-2 border-gray-200';
                    button.textContent = topic.name;
                    button.onclick = () => {
                        appState.currentTopic = topic.id;
                        document.querySelectorAll('.topic-select-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                    };
                    topicSelector.appendChild(button);
                });
                const firstTopicButton = topicSelector.querySelector('.topic-select-btn');
                if (firstTopicButton) {
                    firstTopicButton.click();
                }
            }
            
            function initializeConfigSelectors() {
                questionCountSelector.addEventListener('click', (e) => {
                    if (e.target.dataset.count) {
                        document.querySelectorAll('.q-count-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        appState.totalQuestions = parseInt(e.target.dataset.count);
                    }
                });
            }
            
            function goHome() {
                appState.isSessionActive = false;
                stopTimer();
                reportSection.classList.add('hidden');
                practiceSession.classList.add('hidden');
                controlPanel.classList.remove('hidden');
            }

            function startPractice() {
                let min = parseInt(rangeMinInput.value);
                let max = parseInt(rangeMaxInput.value);
                if(min > max) {
                    [rangeMinInput.value, rangeMaxInput.value] = [max, min];
                    alert("æ•¸å­—ç¯„åœçš„æœ€å°å€¼å¤§æ–¼æœ€å¤§å€¼ï¼Œå·²è‡ªå‹•ç‚ºæ‚¨äº¤æ›ã€‚");
                }

                appState.studentName = studentNameInput.value;
                if (!appState.studentName) {
                    alert('è«‹å…ˆè¼¸å…¥å­¸ç”Ÿåå­—ï¼');
                    return;
                }
                if (!appState.currentTopic) {
                    alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å–®å…ƒï¼');
                    return;
                }
                
                appState.isSessionActive = true;
                appState.startTime = new Date();
                appState.practiceLog = [];
                appState.currentQuestionIndex = 0;
                appState.correctStreak = 0;
                appState.sessionAchievements = [];
                
                controlPanel.classList.add('hidden');
                practiceSession.classList.remove('hidden');
                resizeScratchpad();
                reportSection.classList.add('hidden');
                startTimer();
                loadQuestion();
            }

            function loadQuestion() {
                if (appState.currentQuestionIndex >= appState.totalQuestions) {
                    finishPractice();
                    return;
                }

                appState.minRange = parseInt(rangeMinInput.value) || 1;
                appState.maxRange = parseInt(rangeMaxInput.value) || 10;
                
                currentQuestion = questionGenerators[appState.currentTopic]();
                
                progressTracker.textContent = `ç¬¬ ${appState.currentQuestionIndex + 1} / ${appState.totalQuestions} é¡Œ`;
                
                feedbackText.textContent = '';
                answerSummary.classList.add('hidden');
                nextQuestionBtn.classList.add('hidden');
                
                renderQuestionAndOptions();
                questionStartTime = new Date();
            }
            
            function renderQuestionAndOptions() {
                answerOptionsContainer.innerHTML = '';
                questionDiagram.innerHTML = ''; 
                
                if (currentQuestion.diagram) {
                    questionDiagram.innerHTML = currentQuestion.diagram;
                }

                questionText.innerHTML = currentQuestion.question;
                renderMath(questionText);

                const optionsGrid = document.createElement('div');
                optionsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                
                currentQuestion.options.forEach(option => {
                    const button = document.createElement('button');
                    let displayOption = (typeof option === 'number') ? option.toFixed(2).replace(/\.00$/, '') : option;
                    button.innerHTML = displayOption;
                    button.className = 'choice-btn p-4 rounded-lg border-2 text-xl';
                    button.dataset.value = option;
                    optionsGrid.appendChild(button);
                });
                answerOptionsContainer.appendChild(optionsGrid);
                renderMath(answerOptionsContainer);
            }

            function handleMcqSelection(clickedButton) {
                const selectedValue = clickedButton.dataset.value;
                answerOptionsContainer.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
                
                const isCorrect = Math.abs(parseFloat(selectedValue) - parseFloat(currentQuestion.answer)) < 0.01;
                handleAnswerSubmission(isCorrect, selectedValue);
            }
            
            function handleAnswerSubmission(isCorrect, userAnswer) {
                if (!currentQuestion) return;

                const timeTaken = ((new Date() - questionStartTime) / 1000).toFixed(1);

                appState.practiceLog.push({
                    topicId: appState.currentTopic,
                    question: currentQuestion.question,
                    userAnswer: userAnswer,
                    correctAnswer: currentQuestion.answer,
                    isCorrect: isCorrect,
                    timeTaken: timeTaken
                });
                
                feedbackText.textContent = isCorrect ? 'âœ”ï¸ ç­”å°äº†ï¼' : 'âŒ ä¸å°å–”...';
                feedbackText.className = `text-center font-bold text-lg mt-4 h-6 ${isCorrect ? 'text-green-600' : 'text-red-600'}`;

                answerOptionsContainer.querySelectorAll('.choice-btn').forEach(btn => {
                    const btnValue = parseFloat(btn.dataset.value);
                    const correctValue = parseFloat(currentQuestion.answer);
                    const selectedValue = parseFloat(userAnswer);

                    if (Math.abs(btnValue - correctValue) < 0.01) {
                        btn.classList.add('correct');
                    } else if (Math.abs(btnValue - selectedValue) < 0.01) {
                        btn.classList.add('incorrect');
                    }
                });
                
                answerSteps.innerHTML = currentQuestion.steps;
                let finalAnswerDisplay = (typeof currentQuestion.answer === 'number') 
                    ? currentQuestion.answer.toFixed(2).replace(/\.00$/, '') 
                    : currentQuestion.answer;
                answerFinal.innerHTML = `æ­£ç¢ºç­”æ¡ˆï¼š ${finalAnswerDisplay}`;
                
                if(isCorrect) {
                    guidanceText.textContent = "å¤ªæ£’äº†ï¼é€™æ˜¯é€™é¡Œçš„æ•¸å­¸ç¿»è­¯ï¼š";
                    answerSummary.className = "rounded-xl shadow-inner p-6 mt-4 bg-green-50 text-green-800";
                } else {
                    guidanceText.textContent = getGuidanceText(appState.currentTopic);
                    answerSummary.className = "rounded-xl shadow-inner p-6 mt-4 bg-red-50 text-red-800";
                }
                answerSummary.classList.remove('hidden');
                renderMath(answerSummary);

                nextQuestionBtn.classList.remove('hidden');

                if (appState.currentQuestionIndex >= appState.totalQuestions - 1) {
                    nextQuestionBtn.textContent = 'å®Œæˆç·´ç¿’ & æŸ¥çœ‹å ±å‘Š';
                } else {
                    nextQuestionBtn.textContent = 'ä¸‹ä¸€é¡Œ';
                }
                updateAchievements(isCorrect, timeTaken);
                saveState();
            }

            function nextQuestion() {
                appState.currentQuestionIndex++;
                loadQuestion();
            }
            
            function finishPractice() {
                appState.isSessionActive = false;
                stopTimer();
                practiceSession.classList.add('hidden');
                reportSection.classList.remove('hidden');
                renderReport();
                
                if (!appState.achievements.firstPractice) {
                    unlockAchievement('firstPractice');
                }
                
                const allCorrect = appState.practiceLog.every(log => log.isCorrect);
                if (allCorrect && appState.practiceLog.length > 0) {
                    const masterAchievementId = `master_${appState.currentTopic}`;
                    unlockAchievement(masterAchievementId);
                }
                saveState();
            }

            function analyzeErrors(practiceLog) {
                const wrongAnswers = practiceLog.filter(log => !log.isCorrect);
                if (wrongAnswers.length === 0) {
                    return {
                        analysis: "å¤ªå²å®³äº†ï¼Œæœ¬æ¬¡ç·´ç¿’å…¨éƒ¨ç­”å°ï¼",
                        suggestion: "æ‰€æœ‰æ¦‚å¿µéƒ½æŒæ¡å¾—éå¸¸å¥½äº†ï¼Œç¹¼çºŒä¿æŒï¼"
                    };
                }

                const errorCounts = {};
                wrongAnswers.forEach(log => {
                    errorCounts[log.topicId] = (errorCounts[log.topicId] || 0) + 1;
                });

                const mainErrorTopicId = Object.keys(errorCounts).reduce((a, b) => errorCounts[a] > errorCounts[b] ? a : b);
                const mainErrorTopicName = topics.find(t => t.id === mainErrorTopicId)?.name || 'æœªçŸ¥';

                const analysis = `æœ¬æ¬¡ç·´ç¿’ä¸­ï¼ŒéŒ¯èª¤ä¸»è¦é›†ä¸­åœ¨ã€Œ${mainErrorTopicName}ã€é€™å€‹å–®å…ƒã€‚`;
                const suggestion = getGuidanceText(mainErrorTopicId) + " å¯ä»¥å¤šç·´ç¿’é€™å€‹å–®å…ƒçš„é¡Œç›®ä¾†åŠ å¼·å–”ï¼";

                return { analysis, suggestion };
            }

            function generateFullLogTable(truncate = true) {
                let tableHtml = '<table class="worksheet-table"><thead><tr><th>é¡Œè™Ÿ</th><th>é¡Œç›®</th><th>æ‚¨çš„ç­”æ¡ˆ</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>çµæœ</th><th>ä½œç­”æ™‚é–“</th></tr></thead><tbody>';
                appState.practiceLog.forEach((log, index) => {
                    const questionCellClass = truncate ? 'class="question-truncate"' : '';
                    let userAnswerDisplay = (typeof log.userAnswer === 'number') ? Number(log.userAnswer).toFixed(2).replace(/\.00$/, '') : log.userAnswer;
                    let correctAnswerDisplay = (typeof log.correctAnswer === 'number') ? Number(log.correctAnswer).toFixed(2).replace(/\.00$/, '') : log.correctAnswer;
                    
                    tableHtml += `<tr>
                        <td>${index + 1}</td>
                        <td ${questionCellClass}>${log.question}</td>
                        <td>${userAnswerDisplay}</td>
                        <td>${correctAnswerDisplay}</td>
                        <td>${log.isCorrect ? 'âœ”ï¸' : 'âŒ'}</td>
                        <td>${log.timeTaken}ç§’</td>
                    </tr>`;
                });
                tableHtml += '</tbody></table>';
                return tableHtml;
            }
            
            function generateReportHtml(isForScreen) {
                const total = appState.practiceLog.length;
                if (total === 0) return "";

                const endTime = new Date();
                const correctCount = appState.practiceLog.filter(log => log.isCorrect).length;
                const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;
                const timeTaken = Math.round(((endTime - new Date(appState.startTime)) / 1000));
                const minutes = Math.floor(timeTaken / 60);
                const seconds = timeTaken % 60;
                const timeString = `${minutes} åˆ† ${seconds} ç§’`;
                
                const { analysis, suggestion } = analyzeErrors(appState.practiceLog);

                let achievementsHtml = '';
                if (appState.sessionAchievements.length > 0) {
                    achievementsHtml = '<ul>';
                    appState.sessionAchievements.forEach(id => {
                        const ach = achievementDefs[id];
                        if (ach) {
                            achievementsHtml += `<li class="flex items-center gap-2">ğŸ† <strong>${ach.name}</strong>: ${ach.desc}</li>`;
                        }
                    });
                    achievementsHtml += '</ul>';
                } else {
                    achievementsHtml = '<p>é€™æ¬¡æ²’æœ‰è§£é–æ–°çš„æˆå°±ï¼Œä½†åˆ¥æ°£é¤’ï¼Œä½ å·²ç¶“å¾ˆåŠªåŠ›äº†ï¼</p>';
                }

                const wrongAnswers = appState.practiceLog.filter(log => !log.isCorrect);
                let wrongAnswersHtml = '';
                if (wrongAnswers.length > 0) {
                    wrongAnswersHtml += '<ol class="list-decimal pl-5 space-y-4">';
                    wrongAnswers.forEach(log => {
                        let userAnswerDisplay = (typeof log.userAnswer === 'number') ? Number(log.userAnswer).toFixed(2).replace(/\.00$/, '') : log.userAnswer;
                        let correctAnswerDisplay = (typeof log.correctAnswer === 'number') ? Number(log.correctAnswer).toFixed(2).replace(/\.00$/, '') : log.correctAnswer;

                        wrongAnswersHtml += `<li class="p-2 bg-red-50 border-l-4 border-red-400 rounded">
                            <div class="font-semibold ${isForScreen ? 'question-truncate' : ''}">é¡Œç›®ï¼š${log.question}</div>
                            <div><span class="font-semibold text-red-600">ä½ çš„ç­”æ¡ˆï¼š</span> ${userAnswerDisplay}</div>
                            <div><span class="font-semibold text-green-600">æ­£ç¢ºç­”æ¡ˆï¼š</span> ${correctAnswerDisplay}</div>
                        </li>`;
                    });
                    wrongAnswersHtml += '</ol>';
                }

                const fullLogHtml = generateFullLogTable(isForScreen);

                return `
                    <div class="space-y-6">
                        <div class="text-center">
                            <h2 class="text-3xl font-bold text-sky-700">å­¸ç¿’æˆæœå ±å‘Š</h2>
                            <p class="text-stone-500">${appState.studentName}ï¼Œä½ å®Œæˆäº†ç·´ç¿’ï¼</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="bg-stone-50 p-3 rounded-lg"><strong>é–‹å§‹æ™‚é–“ï¼š</strong> ${new Date(appState.startTime).toLocaleString('zh-TW')}</div>
                            <div class="bg-stone-50 p-3 rounded-lg"><strong>çµæŸæ™‚é–“ï¼š</strong> ${endTime.toLocaleString('zh-TW')}</div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div class="bg-sky-100 p-4 rounded-lg"><div class="text-lg">ç­”å°é¡Œæ•¸</div><div class="text-3xl font-bold">${correctCount} / ${total}</div></div>
                            <div class="bg-green-100 p-4 rounded-lg"><div class="text-lg">æ­£ç¢ºç‡</div><div class="text-3xl font-bold">${accuracy}%</div></div>
                            <div class="bg-yellow-100 p-4 rounded-lg"><div class="text-lg">ç¸½æ™‚é•·</div><div class="text-3xl font-bold">${timeString}</div></div>
                        </div>
                        <div class="bg-amber-50 p-4 rounded-lg border-l-4 border-amber-400">
                            <h3 class="font-bold text-lg text-amber-800">æ­£å‘æ”¯æŒå°èª</h3>
                            <p>æ¯ä¸€æ¬¡çš„ç·´ç¿’ï¼Œéƒ½æ˜¯ä½ è®Šå¾—æ›´å¼·çš„è­‰æ˜ï¼ç„¡è«–çµæœå¦‚ä½•ï¼Œå …æŒä¸‹å»çš„ä½ å°±æ˜¯æœ€æ£’çš„ï¼</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-400">
                            <h3 class="font-bold text-lg text-yellow-800">æœ¬æ¬¡è§£é–æˆå°±</h3>
                            ${achievementsHtml}
                        </div>
                        <div class="bg-rose-50 p-4 rounded-lg border-l-4 border-rose-400">
                            <h3 class="font-bold text-lg text-rose-800">éŒ¯èª¤é¡å‹åˆ†æ</h3>
                            <p>${analysis}</p>
                            <h3 class="font-bold text-lg text-rose-800 mt-2">æ¦‚å¿µåŠ å¼·å»ºè­°</h3>
                            <p>${suggestion}</p>
                        </div>
                        ${wrongAnswers.length > 0 ? `<div class="p-4 rounded-lg"><h3 class="font-bold text-xl mb-2">éŒ¯é¡Œå›é¡§</h3>${wrongAnswersHtml}</div>` : ''}
                        <div class="p-4 rounded-lg">
                            <h3 class="font-bold text-xl mb-2">å®Œæ•´ä½œç­”ç´€éŒ„</h3>
                            <div class="overflow-x-auto">${fullLogHtml}</div>
                        </div>
                    </div>
                `;
            }


            function renderReport() {
                const reportHtmlForScreen = generateReportHtml(true);
                
                reportSection.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold text-stone-700">å­¸ç¿’æˆæœå ±å‘Š</h2>
                        <div class="flex gap-2">
                            <button id="achievements-btn-report" class="bg-yellow-400 text-yellow-900 font-bold py-2 px-4 rounded-lg hover:bg-yellow-500">ğŸ† æŸ¥çœ‹æ‰€æœ‰æˆå°±</button>
                            <button id="restart-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600">è¿”å›é¦–é </button>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center gap-4 my-4">
                       <button id="export-report-word" class="flex-1 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">åŒ¯å‡º WORD</button>
                       <button id="export-report-pdf" class="flex-1 bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">åŒ¯å‡º PDF</button>
                       <button id="export-report-jpg" class="flex-1 bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700">åŒ¯å‡º JPG</button>
                    </div>
                    <div id="report-display-content" class="border-t pt-4 mt-4">${reportHtmlForScreen}</div>
                `;

                requestAnimationFrame(() => {
                    renderMath(reportSection);
                });
                
                document.getElementById('export-report-word').addEventListener('click', () => exportReport('word'));
                document.getElementById('export-report-pdf').addEventListener('click', () => exportReport('pdf'));
                document.getElementById('export-report-jpg').addEventListener('click', () => exportReport('jpg'));
                document.getElementById('achievements-btn-report').addEventListener('click', showAchievements);
                document.getElementById('restart-btn').addEventListener('click', goHome);
            }
            
            function exportHtmlToWord(htmlContent, filename = 'document.doc') {
                const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                    "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                    "xmlns='http://www.w3.org/TR/REC-html40'>"+
                    "<head><meta charset='utf-8'><title>Export HTML to Word</title><style> table { border-collapse: collapse; width: 100%; } td, th { border: 1px solid #dddddd; text-align: left; padding: 8px; } </style></head><body>";
                const footer = "</body></html>";
                const sourceHTML = header + htmlContent + footer;

                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
                const fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = filename;
                fileDownload.click();
                document.body.removeChild(fileDownload);
            }

            function exportReport(format) {
                if (typeof window.jspdf === 'undefined') {
                    alert('PDF åŠŸèƒ½å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                    return;
                }
                const { jsPDF } = window.jspdf;
                const studentName = appState.studentName || 'student';
                const topicName = topics.find(t => t.id === appState.currentTopic)?.name || 'report';
                const filename = `${studentName}_${topicName}_å­¸ç¿’å ±å‘Š`;
                
                const fullReportHtml = generateReportHtml(false);

                if (format === 'word') {
                    exportHtmlToWord(fullReportHtml, `${filename}.doc`);
                } else { 
                    const tempContainer = document.createElement('div');
                    tempContainer.style.position = 'absolute';
                    tempContainer.style.left = '-9999px';
                    tempContainer.style.width = '800px'; 
                    tempContainer.style.padding = '20px';
                    tempContainer.style.backgroundColor = 'white';
                    tempContainer.innerHTML = fullReportHtml;
                    document.body.appendChild(tempContainer);
                    
                    renderMath(tempContainer);

                    html2canvas(tempContainer, { scale: 2 }).then(canvas => {
                        if (format === 'jpg') {
                            const link = document.createElement('a');
                            link.download = `${filename}.jpg`;
                            link.href = canvas.toDataURL('image/jpeg');
                            link.click();
                        } else if (format === 'pdf') {
                            const imgData = canvas.toDataURL('image/png');
                            const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                            pdf.save(`${filename}.pdf`);
                        }
                        document.body.removeChild(tempContainer);
                    }).catch(err => {
                        console.error("html2canvas error:", err);
                        document.body.removeChild(tempContainer);
                    });
                }
            }
            
            function exportWorksheet() {
                const topicName = topics.find(t => t.id === appState.currentTopic)?.name;
                if (!topicName) {
                    alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å–®å…ƒï¼');
                    return;
                }
                appState.minRange = parseInt(rangeMinInput.value) || 1;
                appState.maxRange = parseInt(rangeMaxInput.value) || 10;
                const qCount = appState.totalQuestions;

                const showAnswers = studentNameInput.value.toLowerCase() === 'ffrz';
                let worksheetHtml = `<h1>${topicName} - ç·´ç¿’é¡Œæœ¬</h1><p>ç­ç´šï¼š__________ å§“åï¼š__________</p><hr>`;
                
                for (let i = 0; i < qCount; i++) {
                    const q = questionGenerators[appState.currentTopic]();
                    worksheetHtml += `
                        <div style="margin-top: 20px; page-break-inside: avoid;">
                            <p><strong>ç¬¬ ${i + 1} é¡Œ.</strong> ${q.question}</p>
                            ${q.diagram ? `<div style="width: 200px; height: 150px; margin: 10px 0;">${q.diagram}</div>` : ''}
                            <br><br><br>
                            ${showAnswers ? `
                                <div style="background-color:#f0f0f0; padding: 10px; border-left: 3px solid #ccc; margin-top: 10px;">
                                    <p><strong>è§£ç­”ï¼š</strong>${(typeof q.answer === 'number') ? q.answer.toFixed(2).replace(/\.00$/, '') : q.answer}</p>
                                    <p><strong>æ­¥é©Ÿï¼š</strong><br>${q.steps}</p>
                                </div>` : ''}
                            <hr style="margin-top: 20px;">
                        </div>`;
                }
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = worksheetHtml;
                renderMath(tempDiv);
                
                const filename = `${topicName}_ç·´ç¿’é¡Œæœ¬${showAnswers ? '_(å«è§£ç­”)' : ''}.doc`;
                exportHtmlToWord(tempDiv.innerHTML, filename);
            }


            function startTimer() {
                stopTimer();
                let secondsPassed = appState.isSessionActive && appState.startTime ? Math.floor((new Date() - new Date(appState.startTime)) / 1000) : 0;
                timerInterval = setInterval(() => {
                    secondsPassed++;
                    const min = String(Math.floor(secondsPassed / 60)).padStart(2, '0');
                    const sec = String(secondsPassed % 60).padStart(2, '0');
                    timerEl.textContent = `â±ï¸ ${min}:${sec}`;
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
            }

            function saveState() {
                localStorage.setItem('mathPracticeState_similarity_v2', JSON.stringify(appState));
            }

            function loadState() {
                const savedState = localStorage.getItem('mathPracticeState_similarity_v2');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    appState.achievements = parsedState.achievements || {}; // Always load achievements
                    if (parsedState.isSessionActive && parsedState.practiceLog.length > 0 && parsedState.currentQuestionIndex < parsedState.totalQuestions) {
                        document.getElementById('resume-modal').classList.remove('hidden');
                        document.getElementById('resume-yes').onclick = () => {
                            appState = parsedState;
                            document.getElementById('resume-modal').classList.add('hidden');
                            studentNameInput.value = appState.studentName;
                            document.querySelectorAll('.topic-select-btn').forEach(btn => btn.classList.remove('active'));
                            document.querySelector(`#topic-${appState.currentTopic}`)?.classList.add('active');
                            document.querySelectorAll('.q-count-btn').forEach(btn => {
                                btn.classList.toggle('active', parseInt(btn.dataset.count) === appState.totalQuestions);
                            });
                            controlPanel.classList.add('hidden');
                            practiceSession.classList.remove('hidden');
                            reportSection.classList.add('hidden');
                            startTimer();
                            loadQuestion();
                        };
                        document.getElementById('resume-no').onclick = () => {
                            localStorage.removeItem('mathPracticeState_similarity_v2');
                            document.getElementById('resume-modal').classList.add('hidden');
                        };
                    }
                }
            }
            
            function initializeScratchpad(canvas) {
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let painting = false;

                function setCanvasSize() {
                    const dpr = window.devicePixelRatio || 1;
                    const rect = canvas.getBoundingClientRect();
                    canvas.width = rect.width * dpr;
                    canvas.height = rect.height * dpr;
                    ctx.scale(dpr, dpr);
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.strokeStyle = '#333';
                }
                
                resizeScratchpad = setCanvasSize;

                function getPosition(event) {
                    const rect = canvas.getBoundingClientRect();
                    const source = event.touches ? event.touches[0] : event;
                    return {
                        x: source.clientX - rect.left,
                        y: source.clientY - rect.top
                    };
                }

                function startPainting(e) {
                    e.preventDefault();
                    painting = true;
                    const pos = getPosition(e);
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                }

                function finishPainting() {
                    painting = false;
                }

                function draw(e) {
                    if (!painting) return;
                    e.preventDefault();
                    const pos = getPosition(e);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                }

                canvas.addEventListener('mousedown', startPainting);
                canvas.addEventListener('mouseup', finishPainting);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseout', finishPainting);

                canvas.addEventListener('touchstart', startPainting);
                canvas.addEventListener('touchend', finishPainting);
                canvas.addEventListener('touchmove', draw);

                window.addEventListener('resize', setCanvasSize);
                
                document.getElementById('clear-scratchpad').addEventListener('click', () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                });
            }
            
            const achievementDefs = {
                streak3: { name: "é€£å°3é¡Œï¼", desc: "é€£çºŒç­”å°3é¡Œ" },
                streak5: { name: "é€£å°5é¡Œï¼", desc: "é€£çºŒç­”å°5é¡Œ" },
                quickAnswer: { name: "å¿«å•å¿«ç­”ï¼", desc: "åœ¨10ç§’å…§ç­”å°é¡Œç›®" },
                firstPractice: { name: "åˆæ¬¡ç·´ç¿’ï¼", desc: "å®Œæˆç¬¬ä¸€æ¬¡ç·´ç¿’" },
                master_simple_measurement: { name: "æ¸¬é‡å¤§å¸«", desc: "åœ¨ã€Œç°¡æ˜“æ¸¬é‡ã€ä¸­å…¨å°" },
                master_area_perimeter_ratios: { name: "æ¯”ä¾‹å¤§å¸«", desc: "åœ¨ã€Œé¢ç©èˆ‡å‘¨é•·é—œä¿‚ã€ä¸­å…¨å°" },
                master_special_triangles: { name: "ä¸‰è§’æ¿å¤§å¸«", desc: "åœ¨ã€Œç‰¹æ®Šç›´è§’ä¸‰è§’å½¢ã€ä¸­å…¨å°" },
                master_trig_ratios: { name: "ä¸‰è§’æ¯”å¤§å¸«", desc: "åœ¨ã€Œä¸‰è§’æ¯”ã€ä¸­å…¨å°" }
            };

            function updateAchievements(isCorrect, answerTime) {
                if (isCorrect) {
                    appState.correctStreak++;
                    if (appState.correctStreak >= 3) unlockAchievement('streak3');
                    if (appState.correctStreak >= 5) unlockAchievement('streak5');
                    if (parseFloat(answerTime) <= 10) unlockAchievement('quickAnswer');
                } else {
                    appState.correctStreak = 0;
                }
            }

            function unlockAchievement(id) {
                if (appState.achievements[id]) return;
                appState.achievements[id] = true;
                appState.sessionAchievements.push(id); // Log achievement for this session
                const toast = document.getElementById('achievement-toast');
                document.getElementById('toast-text').textContent = achievementDefs[id].name;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
                saveState();
            }
            
            function showAchievements() {
                const grid = document.getElementById('achievements-grid');
                grid.innerHTML = '';
                for(const [id, ach] of Object.entries(achievementDefs)) {
                    const unlocked = appState.achievements[id];
                    const achDiv = document.createElement('div');
                    achDiv.className = `p-4 rounded-lg text-center ${unlocked ? 'bg-yellow-200' : 'bg-gray-200'}`;
                    achDiv.innerHTML = `<div class="text-4xl mb-2">${unlocked ? 'ğŸ†' : 'â“'}</div><p class="font-bold">${ach.name}</p><p class="text-sm">${ach.desc}</p>`;
                    grid.appendChild(achDiv);
                }
                document.getElementById('achievements-modal').classList.remove('hidden');
            }
            
            function initializeApp() {
                renderTopics();
                initializeConfigSelectors();
                initializeScratchpad(document.getElementById('scratchpad-canvas'));
                
                startPracticeBtn.addEventListener('click', startPractice);
                exportWorksheetBtn.addEventListener('click', exportWorksheet);
                
                answerOptionsContainer.addEventListener('click', e => {
                    if (e.target.matches('.choice-btn')) {
                        handleMcqSelection(e.target);
                    }
                });
                nextQuestionBtn.addEventListener('click', () => {
                    if (appState.currentQuestionIndex >= appState.totalQuestions - 1) {
                        finishPractice();
                    } else {
                        nextQuestion();
                    }
                });

                homeBtn.addEventListener('click', goHome);
                
                document.getElementById('close-achievements').addEventListener('click', () => {
                    document.getElementById('achievements-modal').classList.add('hidden');
                });

                loadState();
            }

            initializeApp();
        });
    </script>
</body>
</html>

